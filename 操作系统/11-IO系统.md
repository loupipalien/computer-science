## I/O 系统
### 目录

### I/O 管理概述
#### I/O 的特点
- I/O 性能经常称为系统性能的瓶颈
- 操作系统庞大复杂原因之一
  - 各种设备传输差异很大
  - 各种应用
  - 控制接口的复杂性
  - 传送单位
  - 数据表示
  - 错误条件
- 与其他功能联系密切, 特别是文件系统
#### I/O 设备分类
- 按数据组织角度分类
  - 块设备: 以数据块为单位存储, 传输信息, 传输速率较高, 可寻址 (随机读写)
  - 字符设备: 以字符为单位存储, 传输信息, 传输速率低, 不可寻址
- 按资源分配角度分类
  - 独占设备: 在一段时间内只能有一个进程使用的设备, 一般为低速 I/O 设备 (如打印机, 磁带等)
  - 共享设备: 在一段时间内可有多个进程共同使用的设备, 多个进程以交叉的方式来使用设备, 其资源利用率高 (如硬盘)
  - 虚设备: 在一类设备上模拟另一类设备, 常用共享设备模拟独占设备, 用高速设备模拟低速设备, 被模拟的设备称为虚设备; 目的是将慢速的独占设备改造成多个用户可共享的设备提高设备的利用率 (如 SPOOLING 技术)
  #### I/O 管理的目标和任务
  - 按照用户的请求, 控制设备的各种操作, 完成 I/O 设备与内存之间的数据交换, 最终完成用户的 I/O 请求
    - 设备分配与回收
      - 记录设备的状态
      - 根据用户的请求和设备的类型, 采用一定的分配方法, 选择一条数据通路
    - 执行设备驱动程序, 实现真正的 I/O 操作
    - 外部设备的中断处理
    - I/O 缓冲区管理
- 建立方便, 统一的独立于设备的接口
  - 方便性: 向用户提供使用外部设备的方便接口, 使用户编程时无须考虑设备复杂的物理特性
  - 统一性：对不同的设备采取统一的操作方式, 即在用户程序中使用的是逻辑设备
    - 逻辑设备与物理设备
    - 屏蔽硬件细节 (设备的物理特性, 错误处理, 不同 I/O 过程的差异性)
- 充分利用各种技术 (通道, 中断, 缓冲, 异步 I/O 等) 提高 CPU 与设备, 设备与设备之间的并行工作能力, 充分利用资源, 提高资源利用率
  - 利用率
  - 均衡性 (使设备充分忙碌)
- 数据保护, 设备传送或管理的数据应该使安全的, 不被破坏的, 保密的

### I/O 硬件组成
#### I/O 设备一般是由机械和电子两部分组成
- 机械部分是设备本身 (物理装置)
- 电子部分又称设备控制器 (或适配器)
  - 端口地址译码
  - 按照主机与设备之间约定的格式和过程接受计算机发来的数据和控制信号, 或向主机发送数据或状态信号
  - 将计算机的数字信号转换成机械部分能识别的模拟信号, 或反之
  - 实现设备内部硬件缓冲, 数据加工等提高性能或增强功能
#### 设备接口控制器的作用
- 操作系统将命令写入控制器的接口寄存器 (或接口缓冲区) 中, 以实现输入/输出, 并从接口寄存器读取状态信息或结果信息
- 当控制器接受一条命令后, 可独立于 CPU 完成指定操作, CPU 可以另外执行其他计算: 命令完成时, 控制器产生一个中断, CPU 响应中断, 控制转给操作系统: 通过读控制器寄存器中的信息, 获得操作结果和设备状态
- 控制器与设备之间的接口常常是一个低级接口
- 控制器的任务: 把串行的流转换为字节块, 并进行必要的错误修正: 首先, 控制器按位进行组装, 然后存入控制器内部的缓冲区中形成以字节为单位的块: 在对块验证检查和并证明无错误时, 再将它复制到内存中
#### I/O 端口地址
- I/O 端口地址: 接口电路中每个寄存器具有的, 唯一的地址, 是个整数
- 所有 I/O 端口地址形成 I/O 端口空间 (受到保护)
- I/O 指令形式与 I/O 地址是相互关联的, 主要有两种形式
  - 内存映像编址 (内存映像 I/O 模式)
  - I/O 独立编址 (I/O 专用指令)
#### I/O 独立编址
- 分配给系统中所有端口的地址空间完全独立, 与内存地址空间无关
- 使用专门的 I/O 指令对端口进程操作
- 优点
  - 外设不占用内存的地址空间
  - 编程时, 易于1区分是对内存操作还是对 I/O 端口操作
- 缺点
  - I/O 端口操作的指令类型少, 操作不灵活
#### 内存映像编址  
- 分配给系统中所有端口的地址空间与内存的地址空间统一编址
- 把 I/O 端口看作使一个存储单元, 对 I/O 的读写操作等同于对内存的操作
- 优点
  - 凡是可对内存操作的指令都可对 I/O 端口操作
  - 不需要专门的 I/O 指令
  - I/O 端口可占有较大的地址空间
- 缺点
  - 占用内存空间
#### 内存映射 I/O 的优点
- 不需要特殊的保护机制来阻止用户进程执行 I/O 操作
- 可以引用内存的每一条指令也可以引用控制寄存器
#### 内存映射 I/O 的缺点
- 对一个设备控制寄存器不能进行高速缓存
- 考虑以下汇编代码循环, 第一次引用 PORT_4 将导致它被高速缓存, 随后的引用只从高速缓存中取值, 并且不会再查询设备, 之后当设备最终变为就绪时, 软件将没有办法发现这一点, 结果循环将会永远进行下去
- 为避免这一情形, 硬件必须针对每个页面具备选择性禁用高速缓存的能力, 操作系统必须管理选择性高速缓存, 所以这一特定为硬件和操作系统两者增添了额外的复杂性
```
LOOP: TEST PORT_4 // 检查端口 4 是否为 0
  BEQ READY       // 如果为 0, 转向 READY
  BRANCH LOOP     // 否则, 继续测试
READY:
```
